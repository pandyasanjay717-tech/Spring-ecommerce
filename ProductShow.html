<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Detail - YesBag</title>
    <link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* ========================================
        GLOBAL STYLES AND RESETS
        ======================================== */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Inter', 'Segoe UI', sans-serif; 
            background: #f4f7f6;
            padding-bottom: 90px; 
            color: #333;
        }

        /* ========================================
        HEADER
        ======================================== */
        .header { 
            position: fixed; top: 0; left: 0; width: 100%; 
            background: #ffffff;
            padding: 15px 20px; 
            display: flex; align-items: center; 
            justify-content: space-between; 
            z-index: 1000; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .header h2 { font-size: 18px; font-weight: 600; color: #1f2937; }
        .back-btn, .share-btn { 
            background: none; border: none; font-size: 22px; 
            cursor: pointer; color: #4CAF50;
            transition: transform 0.2s;
        }
        .back-btn:hover, .share-btn:hover { transform: scale(1.1); }

        /* ========================================
        IMAGE SLIDER & POSITIONING
        ======================================== */
        .main-container { 
            padding: 65px 15px 0;
        }
        .swiper { 
            width: 100%; 
            height: 400px;
            margin-bottom: 5px;
        }
        .swiper-slide { 
            background-size: cover;
            background-repeat: no-repeat;
            background-position: center; 
            border-radius: 0 0 24px 24px; 
            cursor: zoom-in;
        }
        .swiper-pagination-bullet { background: #ddd; opacity: 0.5; }
        .swiper-pagination-bullet-active { background: #4CAF50; opacity: 1; }
        
        /* ========================================
        VARIANT SQUARES SECTION
        ======================================== */
        .variant-squares-section {
            display: flex;
            align-items: center;
            padding: 0 15px 15px;
            gap: 12px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            margin-bottom: 15px;
        }
        .variant-square {
            display: inline-block;
            width: 50px;
            min-width: 50px;
            height: 50px;
            border-radius: 8px;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 3px solid transparent;
        }
        .variant-square.active {
            border-color: #4CAF50;
            transform: scale(1.05);
        }

        /* ========================================
        ZOOM MODAL
        ======================================== */
        #zoomModal {
            display: none;
            position: fixed;
            z-index: 9999;
            left: 0; top: 0;
            width: 100%; height: 100%;
            overflow: hidden;
            background-color: rgba(0,0,0,0.95);
            transition: background-color 0.3s;
        }
        #zoomedImageContainer {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            max-width: 100%;
            max-height: 100%;
            transition: transform 0.3s ease-out;
        }
        #zoomedImage {
            display: block;
            width: auto;
            height: auto;
            max-width: 100vw;
            max-height: 100vh;
            cursor: grab;
            user-select: none;
        }
        .close-zoom {
            position: absolute;
            top: 15px; right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }
        .close-zoom:hover { color: #bbb; }

        /* ========================================
        MAIN CARDS
        ======================================== */
        .card-section {
            background: white; 
            border-radius: 16px; 
            padding: 20px; 
            margin-bottom: 15px; 
            box-shadow: 0 6px 20px rgba(0,0,0,0.08); 
            transition: transform 0.3s;
        }
        .card-section:hover { 
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.12);
        }
        .card-section h3 {
            font-size: 18px; 
            font-weight: 600; 
            color: #1f2937; 
            margin-bottom: 15px; 
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        /* ========================================
        PRICE SECTION
        ======================================== */
        .product-title { 
            font-size: 24px; 
            font-weight: 700; 
            color: #1f2937; 
            margin-bottom: 15px; 
            line-height: 1.3;
        }
        .price-details { 
            display: flex; align-items: center; gap: 15px; flex-wrap: wrap; margin-bottom: 10px; 
        }
        .selling-price { 
            font-size: 32px; 
            font-weight: bold; 
            color: #4CAF50;
            animation: pulse 1.5s infinite;
        }
        .mrp { text-decoration: line-through; font-size: 18px; color: #9ca3af; }
        .discount { 
            background: #FF9800; color: white; 
            padding: 6px 14px; border-radius: 25px; 
            font-weight: 700; font-size: 15px; 
            box-shadow: 0 2px 5px rgba(255,152,0,0.4);
        }

        /* --- NEW: Limited Stock Tag CSS --- */
        .limited-stock-tag {
            background: #dc3545; /* Red Background */
            color: white; 
            padding: 6px 14px; 
            border-radius: 25px; 
            font-weight: 700; 
            font-size: 13px; /* Slightly smaller font */
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 5px rgba(220, 53, 69, 0.4);
            animation: bounce 1.2s infinite; /* Animation */
            margin-left: 10px; /* Spacing */
            border: 2px solid #ffdddd;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-5px);}
            60% {transform: translateY(-2px);}
        }
        /* ------------------------------------- */

        .free-delivery { 
            font-size: 15px; color: #4CAF50; font-weight: 600; 
            display: flex; align-items: center; gap: 5px; 
        }
        .free-delivery i { color: #4CAF50; font-size: 16px; }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }

        /* ========================================
        OFFERS & STORE
        ======================================== */
        .offers-section ul { list-style: none; padding-left: 0; }
        .offers-section li { 
            margin-bottom: 8px; 
            font-size: 14px; 
            color: #4b5563; 
            display: flex; align-items: flex-start;
        }
        .offers-section li i { 
            margin-right: 8px; 
            color: #FF9800; 
            font-size: 16px;
            margin-top: 2px;
        }
        .store-section { 
            display: flex; align-items: center; justify-content: space-between; 
        }
        .store-name { font-size: 16px; font-weight: 600; color: #1f2937; }
        .store-rating { 
            font-size: 14px; color: #6b7280; 
            display: flex; align-items: center; gap: 5px; 
            background: #f3f4f6; padding: 5px 10px; border-radius: 12px;
        }
        .store-rating i { color: #FF9800; }

        /* ========================================
        SELECTION OPTIONS
        ======================================== */
        .option-group { margin-bottom: 20px; }
        .option-group label { 
            display: block; font-weight: 600; margin-bottom: 10px; 
            color: #1f2937; font-size: 15px; 
        }
        .option-grid { display: flex; gap: 10px; flex-wrap: wrap; }
        .option-item { 
            padding: 10px 18px; 
            border: 2px solid #e5e7eb; 
            border-radius: 25px; 
            cursor: pointer; 
            background: #f9fafb; 
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            font-size: 14px;
            color: #4b5563;
        }
        .option-item:hover { 
            background: #f0fdf4;
            border-color: #a7f3d0;
        }
        .option-item.active { 
            border-color: #4CAF50;
            background: #e6ffe6; 
            color: #1f2937; 
            font-weight: 600;
            transform: scale(1.05);
        }

        /* ========================================
        DESCRIPTION
        ======================================== */
        .description { 
            color: #4b5563; line-height: 1.6; margin-bottom: 20px; font-size: 15px; 
        }
        .details-table { display: flex; flex-direction: column; gap: 8px; }
        .detail-row { 
            display: flex; justify-content: space-between; 
            color: #6b7280; font-size: 14px; 
            padding-bottom: 5px;
            border-bottom: 1px dashed #f3f4f6;
        }
        .detail-row span:first-child { font-weight: 500; color: #333; }

        /* ========================================
        RATINGS & REVIEWS
        ======================================== */
        .rating-summary { 
            display: flex; align-items: center; gap: 20px; 
            margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; 
        }
        .avg-rating { 
            font-size: 48px; font-weight: bold; 
            color: #FF9800; line-height: 1; 
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
        }
        .summary-text { font-size: 14px; color: #6c757d; font-weight: 500;}
        .summary-text .stars { 
            font-size: 20px; display: block; margin-top: 5px; color: #FF9800;
        }
        .review-list { display: flex; flex-direction: column; gap: 18px; }
        .review-item { 
            border-left: 4px solid #4CAF50; 
            border-radius: 8px; 
            padding: 15px; 
            background: #f9f9f9; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        .review-header { 
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; 
        }
        .review-stars { color: #FF9800; font-size: 18px; }
        .review-date { font-size: 12px; color: #9ca3af; }
        .review-text { font-size: 15px; color: #333; line-height: 1.5; margin-top: 8px; }
        .review-customer { font-size: 14px; font-weight: 600; color: #1f2937; margin-top: 8px; }
        .no-reviews { color: #dc3545; text-align: center; padding: 20px; font-size: 16px; }

        /* ========================================
        BOTTOM BAR
        ======================================== */
        .bottom-bar { 
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: white; 
            display: flex; justify-content: center; 
            padding: 10px 15px; 
            box-shadow: 0 -4px 15px rgba(0,0,0,0.1);
            z-index: 900;
        }
        .add-cart-btn { 
            padding: 18px 40px; 
            border: none; 
            border-radius: 12px; 
            font-size: 18px; 
            font-weight: bold; 
            flex: 1; 
            max-width: 400px; 
            cursor: pointer; 
            transition: all 0.3s ease; 
            background: #4CAF50; 
            color: white;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        .add-cart-btn i { margin-right: 8px; }
        .add-cart-btn:hover { 
            background: #388E3C; 
            transform: scale(0.98) translateY(-1px); 
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
        }
        .add-cart-btn:active { transform: scale(0.95); }

        /* ========================================
        POPUP
        ======================================== */
        .popup-overlay { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 2000; 
            backdrop-filter: blur(8px);
            animation: fadeIn 0.3s;
        }
        .popup { 
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%) scale(0.9); 
            background: white; 
            padding: 25px; 
            border-radius: 16px; 
            width: 90%; max-width: 400px; 
            text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            animation: popUp 0.3s forwards;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popUp { 100% { transform: translate(-50%, -50%) scale(1); } }
        .popup h3 { margin-bottom: 20px; color: #1f2937; font-size: 20px; }
        .popup .option-group { margin-bottom: 20px; }
        .popup select { 
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; 
            font-size: 15px; background: #f9fafb; cursor: pointer;
            transition: border-color 0.3s;
        }
        .popup select:focus { border-color: #4CAF50; outline: none; }
        .popup .confirm-btn { 
            background: #FF9800; color: white; 
            border: none; padding: 12px 30px; 
            border-radius: 8px; font-size: 16px; 
            cursor: pointer; margin-top: 15px;
            font-weight: 600; transition: background 0.3s;
        }
        .popup .confirm-btn:hover { background: #E65100; }

        /* ========================================
        TOAST
        ======================================== */
        .toast-notification {
            position: fixed;
            top: 80px; right: 20px;
            background: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            z-index: 10000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-weight: 600;
            animation: slideIn 0.3s forwards, slideOut 0.3s 1.7s forwards;
            min-width: 150px;
            text-align: center;
        }
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }

        /* ========================================
        MEDIA QUERIES
        ======================================== */
        @media (max-width: 768px) {
            .swiper { height: 320px; } 
            .price-section .product-title { font-size: 20px; }
            .price-details { flex-direction: column; align-items: flex-start; }
            .selling-price { font-size: 28px; }
            .mrp, .discount { font-size: 16px; }
            .add-cart-btn { padding: 14px 20px; font-size: 16px; max-width: 100%; }
            .main-container { padding: 75px 10px 0; }
            .card-section { padding: 15px; }
            .header { padding: 12px 15px; }
            .header h2 { font-size: 16px; }
            .limited-stock-tag { margin-top: 10px; margin-left: 0; }
        }
    </style>
</head>
<body>
    <div class="header">
        <button class="back-btn" onclick="window.location.href='buyersHome.html'"><i class="fas fa-arrow-left"></i></button>
        <h2>Product Details</h2>
        <button class="share-btn" onclick="shareProduct()"><i class="fas fa-share-alt"></i></button>
    </div>

    <div id="zoomModal" onclick="closeZoomModal(event)">
        <span class="close-zoom" onclick="closeZoomModal(event)">×</span>
        <div id="zoomedImageContainer">
            <img id="zoomedImage" src="" alt="Zoomed Product Image">
        </div>
    </div>

    <div class="main-container">
        <div class="swiper mySwiper">
            <div class="swiper-wrapper" id="imageSlider"></div>
            <div class="swiper-pagination"></div>
        </div>
        
        <div id="variantSquaresSection" class="variant-squares-section"></div>

        <div class="card-section price-section">
            <h1 class="product-title" id="productTitle">Loading Product...</h1>
            <div id="priceSection"></div>
        </div>

        <div class="card-section offers-section" id="offersSection"></div>
        <div class="card-section store-section" id="storeSection"></div>
        <div class="card-section options-section" id="optionsSection"></div>
        <div class="card-section desc-section" id="descSection"></div>

        <div class="card-section reviews-section">
            <h3>Customer Ratings & Reviews</h3>
            <div id="reviewsSummary"></div>
            <div id="reviewsList" class="review-list"></div>
        </div>
    </div>

    <div class="bottom-bar">
        <button class="add-cart-btn" onclick="handleAddToCart()"><i class="fas fa-cart-plus"></i> Add to Cart</button>
    </div>

    <div id="addToCartPopup" class="popup-overlay">
        <div class="popup">
            <h3>Select Options</h3>
            <div id="popupOptions"></div>
            <button class="confirm-btn" onclick="confirmAddToCart()">Confirm & Add to Cart</button>
        </div>
    </div>

    <script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAmAI2z12tk2bnlm__JT24ZGr5giB7Wpk0",
            authDomain: "yesbag-84897.firebaseapp.com",
            databaseURL: "https://yesbag-84897-default-rtdb.firebaseio.com",
            projectId: "yesbag-84897",
            storageBucket: "yesbag-84897.firebasestorage.app",
            messagingSenderId: "2154662115",
            appId: "1:2154662115:web:3382afabeff5519510ddd6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        let currentProduct = {};
        let productId = '';
        let selectedOptions = {}; 
        let allReviews = []; 
        let swiperInstance = null;

        const DEFAULT_IMAGES = [
            'https://via.placeholder.com/600x400?text=Test_Image_1',
            'https://via.placeholder.com/600x400?text=Test_Image_2',
            'https://via.placeholder.com/600x400?text=Test_Image_3'
        ];
        const VARIANT_ATTRIBUTE_KEY = 'color';
        const LIMITED_STOCK_THRESHOLD = 10; // SKU ki limit 10 ya usse kam

        function getProductData(product) {
            const discount = product.mrp && product.price 
                ? Math.round(((product.mrp - product.price) / product.mrp) * 100) 
                : 0;
            
            let images = product.images || DEFAULT_IMAGES;
            let stock = product.stock !== undefined ? product.stock : 99; // Default stock high
            
            const selectedVariantValue = selectedOptions[VARIANT_ATTRIBUTE_KEY];
            
            if (product.variants && selectedVariantValue) {
                const variant = product.variants[selectedVariantValue];
                if (variant) {
                    if (variant.images && variant.images.length > 0) {
                        images = variant.images;
                    }
                    if (variant.stock !== undefined) {
                        stock = variant.stock;
                    }
                }
            }
            
            return {
                images,
                title: product.title || 'Amazing Product',
                price: product.price || 999,
                mrp: product.mrp || 1299,
                discount,
                stock, // Include stock in data
                store: product.store || 'YesBag Store',
                description: product.description || 'No description available.',
                attributes: product.attributes || {}
            };
        }

        async function fetchReviews(productId) {
            try {
                const reviewsRef = ref(db, 'reviews');
                const snapshot = await get(reviewsRef);
                const reviewsObj = snapshot.val() || {};
                
                const productReviews = Object.values(reviewsObj)
                    .filter(review => review.productId === productId);
                
                if (productId === 'test123' && productReviews.length === 0) {
                    // Added a review with only rating for testing the new logic
                    productReviews.push(
                        { productId: 'test123', rating: 5, review: "Fantastic product, very durable!", timestamp: Date.now() - 86400000 },
                        { productId: 'test123', rating: 4, review: null, timestamp: Date.now() - 172800000 }, // Only rating, no review text
                        { productId: 'test123', rating: 4, review: "It was okay, met my expectations.", timestamp: Date.now() - 259200000 }
                    );
                }

                allReviews = productReviews;
                displayReviews(); 
            } catch (error) {
                console.error("Error fetching reviews:", error);
                allReviews = [];
                displayReviews();
            }
        }
        
        function displayReviews() {
            const summaryElement = document.getElementById('reviewsSummary');
            const listElement = document.getElementById('reviewsList');
            
            if (allReviews.length === 0) {
                summaryElement.innerHTML = `<div class="rating-summary"><div class="avg-rating">N/A</div><div class="summary-text">No ratings yet. Be the first to review!</div></div>`;
                listElement.innerHTML = `<div class="no-reviews">No reviews available for this product.</div>`;
                return;
            }

            // 1. Calculate Summary (uses ALL ratings)
            const totalRating = allReviews.reduce((sum, r) => sum + (r.rating || 0), 0);
            const avgRating = (totalRating / allReviews.length).toFixed(1);
            const totalCount = allReviews.length; // Total number of ratings
            const starsHtml = '★'.repeat(Math.round(avgRating)) + '☆'.repeat(5 - Math.round(avgRating));

            summaryElement.innerHTML = `
                <div class="rating-summary">
                    <div class="avg-rating">${avgRating}</div>
                    <div class="summary-text">
                        Average Rating<span class="stars">${starsHtml}</span>
                        <small>(${totalCount} Ratings)</small> 
                    </div>
                </div>
            `;
            
            // 2. Filter reviews for the list (only those with review text)
            const reviewsWithText = allReviews.filter(review => review.review && review.review.trim().length > 0);

            if (reviewsWithText.length === 0) {
                 listElement.innerHTML = `<div class="no-reviews">No written reviews available.</div>`;
                 return;
            }

            // 3. Display the filtered reviews
            const reviewsHtml = reviewsWithText.map(review => {
                const reviewStars = '★'.repeat(review.rating || 0) + '☆'.repeat(5 - (review.rating || 0));
                const date = review.timestamp ? new Date(review.timestamp).toLocaleDateString('en-IN') : 'N/A';
                const reviewText = review.review ? `<div class="review-text">${review.review}</div>` : '';
                return `
                    <div class="review-item">
                        <div class="review-header">
                            <span class="review-stars">${reviewStars}</span>
                            <span class="review-date">${date}</span>
                        </div>
                        ${reviewText}
                        <div class="review-customer">Anonymous Buyer</div>
                    </div>
                `;
            }).join('');
            
            listElement.innerHTML = reviewsHtml;
        }

        async function loadProduct() {
            const urlParams = new URLSearchParams(window.location.search);
            productId = urlParams.get('id') || 'test123';
            
            const productsRef = ref(db, `products/${productId}`);
            const snapshot = await get(productsRef);
            
            if (snapshot.exists()) {
                currentProduct = snapshot.val();
            } else {
                currentProduct = {
                    title: 'YesBag Test Product (Variant Demo)',
                    price: 999,
                    mrp: 1299,
                    stock: 8, // Set a low stock for initial display
                    images: DEFAULT_IMAGES,
                    store: 'Test Store',
                    description: 'This is a description for the test product, demonstrating variant-specific images and option syncing.',
                    attributes: { 
                        size: ['S', 'M', 'L'], 
                        color: ['Red', 'Black', 'Blue'] 
                    }, 
                    variants: {
                        'Red': { images: ['https://via.placeholder.com/600x400/FF5733/FFFFFF?text=Red_Variant_1', 'https://via.placeholder.com/600x400/FF5733/FFFFFF?text=Red_Variant_2'], stock: 15 },
                        'Black': { images: ['https://via.placeholder.com/600x400/000000/FFFFFF?text=Black_Variant_1', 'https://via.placeholder.com/600x400/000000/FFFFFF?text=Black_Variant_2', 'https://via.placeholder.com/600x400/000000/FFFFFF?text=Black_Variant_3'], stock: 5 }, // Low stock variant
                        'Blue': { images: ['https://via.placeholder.com/600x400/337AFF/FFFFFF?text=Blue_Variant'], stock: 11 }
                    }
                };
            }
            
            selectedOptions = {};
            const initialColor = currentProduct.attributes?.[VARIANT_ATTRIBUTE_KEY]?.[0];
            if (initialColor) selectedOptions[VARIANT_ATTRIBUTE_KEY] = initialColor;
            
            displayProduct();
            fetchReviews(productId);
        }

        function getVariantPreviewImage(variantKey) {
            const variant = currentProduct.variants?.[variantKey];
            if (variant && variant.images && variant.images.length > 0) {
                return variant.images[0];
            }
            const colorMap = { 'Red': 'FF5733', 'Black': '000000', 'Blue': '337AFF' };
            const hex = colorMap[variantKey] || '999999';
            return `https://via.placeholder.com/60x60/${hex}/FFFFFF?text=${variantKey[0]}`; 
        }

        function displayProduct() {
            const data = getProductData(currentProduct);
            document.getElementById('productTitle').textContent = data.title;

            // IMAGE SLIDER
            const imageSlider = document.getElementById('imageSlider');
            imageSlider.innerHTML = data.images.map(img => 
                `<div class="swiper-slide" 
                      style="background-image:url('${img}')" 
                      onclick="openZoomModal('${img}')">
                </div>`
            ).join('');
            
            if (swiperInstance) swiperInstance.destroy(true, true);
            swiperInstance = new Swiper('.mySwiper', {
                pagination: { el: '.swiper-pagination', clickable: true },
                loop: true
            });

            // VARIANT SQUARES
            const variantSquaresSection = document.getElementById('variantSquaresSection');
            let squaresHtml = '';
            const colors = currentProduct.attributes?.[VARIANT_ATTRIBUTE_KEY];
            if (colors && currentProduct.variants) {
                squaresHtml = colors.map(value => {
                    const preview = getVariantPreviewImage(value);
                    const active = selectedOptions[VARIANT_ATTRIBUTE_KEY] === value ? ' active' : '';
                    return `
                        <div class="variant-square${active}" 
                             style="background-image:url('${preview}')"
                             data-value="${value}"
                             onclick="selectOption('${VARIANT_ATTRIBUTE_KEY}', '${value}', this, true)">
                        </div>
                    `;
                }).join('');
            }
            variantSquaresSection.innerHTML = squaresHtml;
            variantSquaresSection.style.display = squaresHtml ? 'flex' : 'none';

            // PRICE
            // Limited Stock Tag Logic
            const limitedStockTag = data.stock <= LIMITED_STOCK_THRESHOLD
                ? `<div class="limited-stock-tag"><i class="fas fa-exclamation-triangle"></i> Hurry, Only few pieces left!</div>`
                : '';
            
            document.getElementById('priceSection').innerHTML = `
                <div class="price-details">
                    <div class="selling-price">₹${data.price}</div>
                    <div class="mrp">₹${data.mrp}</div>
                    ${data.discount > 0 ? `<div class="discount">${data.discount}% off</div>` : ''}
                    ${limitedStockTag} </div>
                <div class="free-delivery"><i class="fas fa-shipping-fast"></i> Free Delivery</div>
            `;

            // OFFERS
            const offersSection = document.getElementById('offersSection');
            offersSection.innerHTML = `
                <h3>Available Offers</h3>
                <ul>
                    ${data.discount > 0 ? `<li><i class="fas fa-tag"></i> Flat ${data.discount}% OFF on this product!</li>` : ''}
                    <li><i class="fas fa-hand-holding-usd"></i> ₹50 Cashback on UPI payment.</li>
                    <li><i class="fas fa-undo"></i> Easy 7-day return policy.</li>
                </ul>
            `;

            // STORE
            document.getElementById('storeSection').innerHTML = `
                <div class="store-name"><i class="fas fa-store"></i> Sold by: ${data.store}</div>
                <div class="store-rating"><i class="fas fa-star"></i> <span id="storeRatingValue">4.5</span></div>
            `;

            // OPTIONS
            const optionsSection = document.getElementById('optionsSection');
            let optionsHtml = '';
            const attributes = currentProduct.attributes || {};
            for (const [key, values] of Object.entries(attributes)) {
                if (Array.isArray(values) && values.length > 0) {
                    const label = key.charAt(0).toUpperCase() + key.slice(1);
                    const selected = selectedOptions[key] || '';
                    optionsHtml += `
                        <div class="option-group" data-attr-type="${key}">
                            <label>Select ${label}:</label>
                            <div class="option-grid">
                                ${values.map(v => {
                                    const active = selected === v ? ' active' : '';
                                    const rerender = key === VARIANT_ATTRIBUTE_KEY ? 'true' : 'false';
                                    return `<div class="option-item${active}" 
                                                  data-value="${v}" 
                                                  onclick="selectOption('${key}', '${v}', this, ${rerender})">${v}</div>`;
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            optionsSection.innerHTML = optionsHtml;
            optionsSection.style.display = optionsHtml ? 'block' : 'none';

            // DESCRIPTION
            let detailsHtml = '';
            for (const [k, v] of Object.entries(currentProduct.attributes || {})) {
                const val = Array.isArray(v) ? v.join(', ') : v;
                detailsHtml += `<div class="detail-row"><span>${k.charAt(0).toUpperCase() + k.slice(1)}:</span><span>${val}</span></div>`;
            }
            document.getElementById('descSection').innerHTML = `
                <h3>Product Description</h3>
                <div class="description">${data.description}</div>
                ${detailsHtml ? `<div class="details-table">${detailsHtml}</div>` : ''}
            `;
        }

        window.selectOption = (type, value, element, shouldRerender = false) => {
            const container = document.querySelector(`.option-group[data-attr-type="${type}"]`);
            if (container) {
                container.querySelectorAll('.option-item').forEach(opt => opt.classList.remove('active'));
                const target = container.querySelector(`.option-item[data-value="${value}"]`);
                if (target) target.classList.add('active');
            }
            selectedOptions[type] = value;

            if (type === VARIANT_ATTRIBUTE_KEY) {
                document.querySelectorAll('.variant-square').forEach(sq => sq.classList.remove('active'));
                const sq = document.querySelector(`.variant-square[data-value="${value}"]`);
                if (sq) sq.classList.add('active');
                shouldRerender = true;
            }
            if (shouldRerender) displayProduct();
        };

        function handleAddToCart() {
            const required = Object.keys(currentProduct.attributes || {});
            if (required.length === 0) return addToCartDirectly(true);

            const allSelected = required.every(k => selectedOptions[k]);
            if (allSelected) return addToCartDirectly(true);
            showAddToCartPopup();
        }

        function showAddToCartPopup() {
            const popup = document.getElementById('addToCartPopup');
            const opts = document.getElementById('popupOptions');
            let html = '';
            const attrs = currentProduct.attributes || {};
            for (const key of Object.keys(attrs)) {
                const vals = attrs[key];
                if (Array.isArray(vals) && vals.length > 0) {
                    const sel = selectedOptions[key] || '';
                    const label = key.charAt(0).toUpperCase() + key.slice(1);
                    html += `
                        <div class="option-group">
                            <label>Select ${label}:</label>
                            <select id="${key}Select" onchange="updateSelectedOptions('${key}', this.value)">
                                <option value="">Select ${label}</option>
                                ${vals.map(v => `<option value="${v}" ${v===sel?'selected':''}>${v}</option>`).join('')}
                            </select>
                        </div>
                    `;
                }
            }
            opts.innerHTML = html;
            popup.style.display = 'block';
        }

        window.updateSelectedOptions = (type, value) => {
            const rerender = (type === VARIANT_ATTRIBUTE_KEY);
            if (value) selectedOptions[type] = value;
            else delete selectedOptions[type];
            window.selectOption(type, value, null, rerender);
        };

        window.confirmAddToCart = () => {
            const required = Object.keys(currentProduct.attributes || {});
            const ok = required.every(k => selectedOptions[k]);
            if (!ok) { alert('Please select all options.'); return; }
            document.getElementById('addToCartPopup').style.display = 'none';
            addToCartDirectly(true);
        };

        function addToCartDirectly(redirect) {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const optStr = Object.keys(selectedOptions).sort().map(k => `${k}:${selectedOptions[k]}`).join('|');
            const uid = `${productId}_${optStr}`;
            let item = cart.find(i => i.uniqueId === uid);
            if (item) {
                item.qty += 1;
            } else {
                const data = getProductData(currentProduct);
                cart.push({
                    id: productId,
                    uniqueId: uid,
                    title: currentProduct.title || 'Product',
                    image: data.images?.[0] || 'https://via.placeholder.com/150?text=Product',
                    price: currentProduct.price || 999,
                    qty: 1,
                    options: { ...selectedOptions }
                });
            }
            localStorage.setItem('cart', JSON.stringify(cart));

            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.innerHTML = '<i class="fas fa-check-circle"></i> Added to Cart!';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);

            if (redirect) setTimeout(() => window.location.href = 'cart.html', 500);
        }

        window.openZoomModal = src => {
            document.getElementById('zoomedImage').src = src;
            document.getElementById('zoomModal').style.display = 'block';
            document.getElementById('zoomedImageContainer').style.transform = 'translate(-50%, -50%) scale(1.05)';
        };

        window.closeZoomModal = e => {
            if (e && e.target !== document.getElementById('zoomModal') && e.target.className !== 'close-zoom') return;
            document.getElementById('zoomModal').style.display = 'none';
            document.getElementById('zoomedImageContainer').style.transform = 'translate(-50%, -50%) scale(1)';
        };

        function shareProduct() {
            if (navigator.share) {
                navigator.share({
                    title: currentProduct.title || 'Check out this product!',
                    text: currentProduct.description || 'Amazing product on YesBag!',
                    url: window.location.href,
                }).catch(() => {});
            } else {
                alert('Link copied: ' + window.location.href);
            }
        }

        document.getElementById('addToCartPopup').addEventListener('click', e => {
            if (e.target.id === 'addToCartPopup') e.target.style.display = 'none';
        });

        window.selectOption = window.selectOption;
        window.handleAddToCart = handleAddToCart;
        window.updateSelectedOptions = window.updateSelectedOptions;
        window.confirmAddToCart = window.confirmAddToCart;
        window.shareProduct = shareProduct;
        window.openZoomModal = openZoomModal;
        window.closeZoomModal = closeZoomModal;

        loadProduct();
    </script>
</body>
</html>
