<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Category Products - YesBag</title> 
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* --- General and Header Styles (Copied from index.html for consistency) --- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: #fdfcf9; 
            min-height: 100vh; 
            padding-top: 60px; 
            color: #333;
            display: flex;
            flex-direction: column;
        }
        
        .header { 
            position: fixed; top: 0; left: 0; width: 100%; height: 60px; 
            background: #FFC300; 
            z-index: 1000; display: flex; 
            align-items: center; justify-content: space-between; 
            padding: 0 15px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .logo { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }
        .icon-btn { 
            font-size: 20px; cursor: pointer; color: #2c3e50; 
            position: relative; padding: 5px; margin-left: 10px;
        }
        
        #cartBadge { 
            display: none; background: #E94C3D; 
            color: white; border-radius: 50%; 
            padding: 2px 6px; font-size: 10px; position: absolute; top: -8px; right: -8px; 
            font-weight: bold;
        }
        .hamburger-menu { display: none; } /* Simplified for this page */

        /* --- Category Specific Styles --- */
        .main-content {
            flex: 1;
            padding: 15px;
        }
        
        .category-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 10px 0;
            border-bottom: 2px solid #E94C3D;
        }
        
        .back-btn {
            font-size: 24px;
            color: #2c3e50;
            margin-right: 15px;
            cursor: pointer;
        }

        .category-title {
            font-size: 24px;
            font-weight: 700;
            color: #2c3e50;
        }

        .products-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
            gap: 15px; 
            padding-bottom: 20px; 
        }
        
        /* --- Product Card Styles (Copied from index.html) --- */
        .product-card { 
            background: white; 
            border-radius: 12px; 
            overflow: hidden; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); 
            cursor: pointer; 
            position: relative; 
            transition: transform 0.2s;
        }
        .product-card:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(0,0,0,0.1); }
        .product-card.gold-product {
            border: 3px solid #FFD700; 
            box-shadow: 0 0 10px #FFD700, 0 0 20px #FFD700; 
        }
        .product-card.gold-product:hover {
            box-shadow: 0 0 15px #FFD700, 0 0 30px #FFD700;
        }
        .gold-marker-container {
            position: absolute; top: 5px; left: 5px; z-index: 15; display: flex;
            align-items: center; background: rgba(0, 0, 0, 0.7); padding: 3px 8px;
            border-radius: 4px;
        }
        .gold-marker-container .crown-symbol { font-size: 1.2em; margin-right: 5px; }
        .gold-marker-container .gold-text {
            color: #FFD700; font-weight: bold; font-size: 14px;
            text-transform: uppercase; text-shadow: 0 0 5px #FFD700, 0 0 10px #FFC300;
        }
        .product-image { 
            height: 160px; 
            background-size: cover; /* Changed to cover for better image display */
            background-position: center; 
            position: relative; 
        }
        .like-btn { position: absolute; top: 8px; right: 8px; font-size: 18px; color: #E94C3D; background: rgba(255,255,255,0.8); border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        .product-content {
             padding: 10px 10px 5px; 
             display: flex; 
             flex-direction: column;
             gap: 5px;
        }
        .product-title { 
            font-weight: 500; 
            font-size: 15px; 
            color: #333; 
            line-height: 1.3; 
            min-height: 40px;
            margin-bottom: 0;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .product-price { padding: 0 10px 5px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
        .selling-price { font-weight: bold; font-size: 18px; color: #157347; }
        .mrp { text-decoration: line-through; font-size: 13px; color: #999; }
        .discount { color: #157347; font-weight: bold; font-size: 13px; background: #d4edda; padding: 2px 6px; border-radius: 4px;}
        .ratings { padding: 0 10px 10px; display: flex; justify-content: space-between; align-items: center; }
        .rating-stars { background: #FFC300; color: #333; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        
        .feature-badge { 
            position: absolute; top: 12px; left: 0; 
            padding: 4px 8px 4px 15px; 
            background: linear-gradient(to right, rgba(255,255,255,0.9), rgba(255,255,255,0.7)); 
            color: #333; 
            font-size: 11px; 
            font-weight: 700; 
            letter-spacing: 0.5px;
            z-index: 10;
            border-top-right-radius: 5px;
            border-bottom-right-radius: 5px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.1);
        }
        .s-trusted-badge { color: #5a2e9d; border-left: 5px solid #8b5cf6; }
        .branded-badge { color: #E94C3D; border-left: 5px solid #E94C3D; }
        .seasonal-badge {
            display: inline-block; margin: 0 10px; padding: 4px 8px;
            background: #f97316; color: white; border-radius: 4px;
            font-size: 11px; font-weight: 600; text-align: center;
            line-height: 1; margin-bottom: 5px;
        }

        /* --- Footer Styles (Copied from index.html for consistency) --- */
        .footer {
            background: #2c3e50;
            color: white;
            padding: 30px 15px 20px;
            margin-top: auto; /* Push footer to the bottom */
            border-top: 1px solid #34495e;
            flex-shrink: 0;
        }
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .footer-links {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        .footer-links a {
            color: #FFC300;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
        }
        .footer-social {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        .footer-contact {
            font-size: 14px;
            color: #bdc3c7;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .footer-copyright {
            text-align: center;
            font-size: 13px;
            color: #95a5a6;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #34495e;
        }

        @media (max-width: 480px) {
            .category-title { font-size: 22px; }
            .products-grid { grid-template-columns: repeat(2, 1fr); }
            .footer { padding: 25px 10px 15px; }
        }
    </style>
</head>
<body>

    <div class="header">
        <div class="icon-btn" onclick="window.history.back()">
             <i class="fa-solid fa-arrow-left"></i>
        </div>
        <img src="" data-src="logo.png" id="mainLogo" class="logo" alt="YesBag Logo" style="position: absolute; left: 50%; transform: translateX(-50%);">
        <div>
             <div class="icon-btn cart-icon" onclick="window.location.href='cart.html'">
                <i class="fa-solid fa-cart-shopping"></i><span id="cartBadge">0</span>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="category-header">
            <h1 class="category-title" id="categoryPageTitle">Category Products</h1>
        </div>

        <div class="products-grid" id="categoryProductsList">
            <div style="text-align:center;padding:40px;color:#6c757d;grid-column:1/-1;" id="loadingMessage">
                Loading products for category...
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-about">
                <strong>YesBag</strong> ‚Äî Your trusted online shopping destination for quality products at unbeatable prices. Shop with confidence!
            </div>
            <div class="footer-links">
                <a href="about.html">About Us</a>
                <a href="privacy.html">Privacy Policy</a>
                <a href="terms.html">Terms of Service</a>
                <a href="contact.html">Contact</a>
            </div>
            <div class="footer-social">
                <a href="https://instagram.com/yesbag" target="_blank"><i class="fab fa-instagram"></i></a>
                <a href="https://facebook.com/yesbag" target="_blank"><i class="fab fa-facebook"></i></a>
            </div>
            <div class="footer-contact">
                <i class="fas fa-phone"></i> +91 98765 43210
            </div>
            <div class="footer-copyright">
                ¬© 2025 YesBag. All rights reserved.
            </div>
        </div>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // IMPORTANT: Replace with your actual Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyAmAI2z12tk2bnlm__JT24ZGr5giB7Wpk0",
            authDomain: "yesbag-84897.firebaseapp.com",
            databaseURL: "https://yesbag-84897-default-rtdb.firebaseio.com",
            projectId: "yesbag-84897",
            storageBucket: "yesbag-84897.firebasestorage.app",
            messagingSenderId: "2154662115",
            appId: "1:2154662115:web:3382afabeff5519510ddd6"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // --- UTILITY FUNCTIONS ---

        function getUrlParameter(name) {
            name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
            const regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
            const results = regex.exec(location.search);
            return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
        }
        
        function getProductData(item, firebaseKey, totalRatings = 4.5, usersRated = 0) {
            const mrp = parseFloat(item.mrp) || parseFloat(item.price) || 0;
            const price = parseFloat(item.price) || mrp || 0;
            
            let discount = 0;
            if (mrp > price && mrp > 0) {
                 discount = Math.round(((mrp - price) / mrp) * 100);
            }

            return {
                id: firebaseKey || 'unknown',
                image: item.images?.[0] || 'https://via.placeholder.com/160?text=Product',
                title: item.title || 'Amazing Product',
                price: price.toFixed(0),
                mrp: mrp.toFixed(0),
                discount: discount,
                offer: item.offer || null,
                totalRatings: totalRatings, 
                usersRated: usersRated, 
                firebaseKey: firebaseKey,
                markedAs: item.markedAs || '',
            };
        }

        function createProductCardHtml(productData) {
            let featureBadgeHtml = '';
            let seasonalBadgeHtml = '';
            let cardClasses = 'product-card'; 
            let goldMarkerHtml = ''; 
            
            if (productData.markedAs === 's-trusted') {
                featureBadgeHtml = '<div class="feature-badge s-trusted-badge">S-TRUSTED</div>';
            } else if (productData.markedAs === 'branded') {
                featureBadgeHtml = '<div class="feature-badge branded-badge">BRANDED</div>';
            } else if (productData.markedAs === 'seasonal') {
                seasonalBadgeHtml = '<span class="seasonal-badge">LIMITED TIME OFFER</span>';
            }

            if (productData.markedAs === 'gold') {
                 cardClasses += ' gold-product'; 
                 goldMarkerHtml = `
                    <div class="gold-marker-container">
                        <span class="crown-symbol">üëë</span> 
                        <span class="gold-text">GOLD</span>
                    </div>
                 `; 
            }
            
            const ratingStarsHtml = `<i class="fa-solid fa-star"></i> ${productData.totalRatings.toFixed(1)}`;
            
            return `
                <div class="${cardClasses}" 
                     onclick="window.location.href='ProductShow.html?id=${productData.id}'">
                    <div class="product-image" style="background-image: url(${productData.image});">
                        <div class="like-btn"><i class="fa-regular fa-heart"></i></div>
                        ${featureBadgeHtml}
                        ${goldMarkerHtml} </div>
                    <div class="product-content">
                        <div class="product-title">${productData.title}</div>
                        ${seasonalBadgeHtml} 
                    </div>
                    <div class="product-price">
                        <span class="selling-price">‚Çπ${productData.price}</span>
                        <span class="mrp">‚Çπ${productData.mrp}</span>
                        <span class="discount">${productData.discount}% OFF</span>
                    </div>
                    <div class="ratings">
                        <span class="rating-stars">${ratingStarsHtml}</span>
                        <span class="rated-peoples">(${productData.usersRated} ratings)</span>
                    </div>
                </div>
            `;
        }
        
        async function loadLogoUrl() {
            const logoRef = ref(db, 'admin/settings/logoUrl');
            try {
                const snapshot = await get(logoRef);
                const logoUrl = snapshot.val();
                if (logoUrl) {
                    document.getElementById('mainLogo').src = logoUrl;
                } else {
                    document.getElementById('mainLogo').src = document.getElementById('mainLogo').getAttribute('data-src');
                }
            } catch (e) {
                console.error("Error loading logo:", e);
                document.getElementById('mainLogo').src = document.getElementById('mainLogo').getAttribute('data-src');
            }
        }
        
        function updateCartBadge() {
            const cart = JSON.parse(localStorage.getItem('cart') || '[]');
            const badge = document.getElementById('cartBadge');
            if (cart.length > 0) {
                badge.textContent = cart.length;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }
        
        // --- MAIN LOGIC: LOAD CATEGORY PRODUCTS (UPDATED FOR MULTI-PRODUCT LINKS) ---

        async function loadCategoryProducts() {
            // ‚≠ê NEW: We now read the 'id' parameter, which will be the Firebase Key of the custom category
            const categoryFirebaseId = getUrlParameter('id'); 
            const productsListEl = document.getElementById('categoryProductsList');
            const titleEl = document.getElementById('categoryPageTitle');
            const loadingMessageEl = document.getElementById('loadingMessage');
            
            productsListEl.innerHTML = ''; // Clear existing content
            loadingMessageEl.style.display = 'block';
            loadingMessageEl.innerHTML = 'Loading products for category...';
            
            if (!categoryFirebaseId) {
                titleEl.textContent = 'Category Not Found';
                loadingMessageEl.innerHTML = 'Error: Custom Category ID not found in URL. Please go back to the home page.';
                return;
            }

            let categoryName = 'Custom Category';
            let linkedProductIds = {};

            // 1. Fetch Category Details and Linked Product IDs
            try {
                const categoryRef = ref(db, `admin/buyerHomePage/categories/${categoryFirebaseId}`);
                const categorySnap = await get(categoryRef);
                const categoryData = categorySnap.val();
                
                if (categoryData) {
                    categoryName = categoryData.name || categoryName;
                    // productIds is stored as an object {PROD_ID_1: true, PROD_ID_2: true}
                    linkedProductIds = categoryData.productIds || {};
                }
                
                titleEl.textContent = categoryName;
                document.title = `${categoryName} - YesBag`;

                if (Object.keys(linkedProductIds).length === 0) {
                     loadingMessageEl.innerHTML = `<div style="text-align:center;padding:40px;color:#999;grid-column:1/-1;">No products have been linked to the category <strong>${categoryName}</strong> yet.</div>`;
                     loadingMessageEl.style.display = 'block';
                     return;
                }

            } catch(e) {
                console.error("Error fetching category details:", e);
                titleEl.textContent = 'Category Load Error';
                loadingMessageEl.innerHTML = 'Error loading category details. Please check connection.';
                return;
            }

            // 2. Fetch All Products and Reviews (Optimized)
            try {
                const productsRef = ref(db, 'products');
                const reviewsRef = ref(db, 'reviews');
                
                const [productSnapshot, reviewsSnapshot] = await Promise.all([get(productsRef), get(reviewsRef)]);
                const productsObj = productSnapshot.val() || {};
                const allReviews = Object.values(reviewsSnapshot.val() || {});

                let activeProductsToDisplay = [];
                
                // 3. Filter Products based on linkedProductIds
                Object.keys(linkedProductIds).forEach(productId => {
                    const product = productsObj[productId];
                    
                    // Only display product if it exists in 'products' and is not a draft/inactive
                    if (product && product.isDraft !== true && product.active !== false) {
                        
                        // Calculate average rating for the product
                        const productReviews = allReviews.filter(review => review.productId === productId);
                        let totalRating = 4.5;
                        if (productReviews.length > 0) {
                            totalRating = productReviews.reduce((sum, review) => sum + (review.rating || 0), 0) / productReviews.length;
                            totalRating = parseFloat(totalRating.toFixed(1));
                        } 

                        activeProductsToDisplay.push({ 
                            ...product, 
                            firebaseKey: productId,
                            totalRatings: totalRating,
                            usersRated: productReviews.length 
                        });
                    }
                });
                
                // 4. Render Filtered Products
                loadingMessageEl.style.display = 'none';
                
                if (activeProductsToDisplay.length === 0) {
                    productsListEl.innerHTML = `<div style="text-align:center;padding:40px;color:#999;grid-column:1/-1;">The category <strong>${categoryName}</strong> has linked products, but they might be marked as Draft or Inactive.</div>`;
                    return;
                }

                const productsHtml = activeProductsToDisplay.map(product => {
                    // Pass the calculated ratings to getProductData
                    const data = getProductData(product, product.firebaseKey, product.totalRatings, product.usersRated); 
                    return createProductCardHtml(data);
                }).join('');

                productsListEl.innerHTML = productsHtml;

            } catch (error) {
                console.error("Error loading products data:", error);
                loadingMessageEl.innerHTML = '<div style="text-align:center;padding:40px;color:#dc3545;grid-column:1/-1;">Error loading products. Please check Firebase connection and try again.</div>';
                loadingMessageEl.style.display = 'block';
            }
        }


        // --- INIT ---
        window.addEventListener('load', () => {
            loadLogoUrl();
            loadCategoryProducts();
            updateCartBadge();
        });
        window.addEventListener('storage', updateCartBadge); 
    </script>
</body>
</html>
